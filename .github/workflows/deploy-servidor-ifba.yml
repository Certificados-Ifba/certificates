name: Deploy Certificates IFBA

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://200.128.9.4:4000

    steps:
      # 1ï¸âƒ£ Clona o repositÃ³rio (necessÃ¡rio pro Actions pegar estrutura)
      - name: ğŸ“¦ Checkout cÃ³digo
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Configura o SSH (chave privada vinda do secret)
      - name: ğŸ”‘ Configurar acesso SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # 3ï¸âƒ£ Testa se a conexÃ£o SSH com o servidor remoto funciona
      - name: ğŸŒ Testar conexÃ£o SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
              -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
              "echo 'âœ… ConexÃ£o SSH funcionando no servidor remoto!'"

      # 4ï¸âƒ£ Gera e envia o arquivo .env completo
      - name: ğŸ§© Gerar e enviar arquivo .env
        env:
          # ğŸ”§ VariÃ¡veis de ambiente (nÃ£o secretas)
          DOMAIN: ${{ vars.DOMAIN }}
          API_URI: ${{ vars.API_URI }}
          WEB_URL: ${{ vars.WEB_URL }}
          WEB_PORT: ${{ vars.WEB_PORT }}
          API_GATEWAY_PORT: ${{ vars.API_GATEWAY_PORT }}
          API_GATEWAY_HOST: ${{ vars.API_GATEWAY_HOST }}
          HOST_MONGO_PORT: ${{ vars.HOST_MONGO_PORT }}
          MONGO_PORT: ${{ vars.MONGO_PORT }}
          MONGO_GUI_PORT: ${{ vars.MONGO_GUI_PORT }}
          HCAPTCHA_SITEKEY: ${{ vars.HCAPTCHA_SITEKEY }}
          MAILER_TLS: ${{ vars.MAILER_TLS }}
          MAILER_SECURE: ${{ vars.MAILER_SECURE }}
          MAILER_DISABLED: ${{ vars.MAILER_DISABLED }}

          # ğŸ§© MicroserviÃ§os backend
          USER_SERVICE_HOST: ${{ vars.USER_SERVICE_HOST }}
          USER_SERVICE_PORT: ${{ vars.USER_SERVICE_PORT }}
          EVENT_SERVICE_HOST: ${{ vars.EVENT_SERVICE_HOST }}
          EVENT_SERVICE_PORT: ${{ vars.EVENT_SERVICE_PORT }}
          TOKEN_SERVICE_HOST: ${{ vars.TOKEN_SERVICE_HOST }}
          TOKEN_SERVICE_PORT: ${{ vars.TOKEN_SERVICE_PORT }}
          MAILER_SERVICE_HOST: ${{ vars.MAILER_SERVICE_HOST }}
          MAILER_SERVICE_PORT: ${{ vars.MAILER_SERVICE_PORT }}
          PERMISSION_SERVICE_HOST: ${{ vars.PERMISSION_SERVICE_HOST }}
          PERMISSION_SERVICE_PORT: ${{ vars.PERMISSION_SERVICE_PORT }}
          GENERIC_SERVICE_HOST: ${{ vars.GENERIC_SERVICE_HOST }}
          GENERIC_SERVICE_PORT: ${{ vars.GENERIC_SERVICE_PORT }}
          ACTIVITY_SERVICE_HOST: ${{ vars.ACTIVITY_SERVICE_HOST }}
          ACTIVITY_SERVICE_PORT: ${{ vars.ACTIVITY_SERVICE_PORT }}
          CERTIFICATE_SERVICE_HOST: ${{ vars.CERTIFICATE_SERVICE_HOST }}
          CERTIFICATE_SERVICE_PORT: ${{ vars.CERTIFICATE_SERVICE_PORT }}
          STORAGE_SERVICE_HOST: ${{ vars.STORAGE_SERVICE_HOST }}
          STORAGE_SERVICE_PORT: ${{ vars.STORAGE_SERVICE_PORT }}

          # ğŸ” Secrets sensÃ­veis
          APP_SECRET: ${{ secrets.APP_SECRET }}
          HCAPTCHA_SECRET: ${{ secrets.HCAPTCHA_SECRET }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
          MONGODB_ROOT_PASSWORD: ${{ secrets.MONGODB_ROOT_PASSWORD }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_GUI_USER: ${{ secrets.MONGO_GUI_USER }}
          MONGO_GUI_PASSWORD: ${{ secrets.MONGO_GUI_PASSWORD }}
          TOKEN_EXPIRES_IN: ${{ secrets.TOKEN_EXPIRES_IN }}
          MAILER_HOST: ${{ secrets.MAILER_HOST }}
          MAILER_PORT: ${{ secrets.MAILER_PORT }}
          MAILER_USER: ${{ secrets.MAILER_USER }}
          MAILER_PASS: ${{ secrets.MAILER_PASS }}
          MAILER_FROM: ${{ secrets.MAILER_FROM }}

        run: |
          echo "ğŸ“„ Gerando .env.deploy..."

          cat > .env.deploy <<EOF
          # ========================================
          # CONFIGURAÃ‡Ã•ES DE DOMÃNIO E HOSTS
          # ========================================
          DOMAIN=${DOMAIN}
          API_URI=${API_URI}
          WEB_URL=${WEB_URL}
          WEB_PORT=${WEB_PORT}
          API_GATEWAY_PORT=${API_GATEWAY_PORT}
          API_GATEWAY_HOST=${API_GATEWAY_HOST}

          # ========================================
          # CONFIGURAÃ‡Ã•ES DO MONGODB
          # ========================================
          MONGO_USER=${MONGO_USER}
          MONGO_PASSWORD=${MONGO_PASSWORD}
          MONGO_DATABASE=${MONGO_DATABASE}
          MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
          MONGO_PORT=${MONGO_PORT}
          HOST_MONGO_PORT=${HOST_MONGO_PORT}
          MONGO_HOST=${MONGO_HOST}
          MONGO_GUI_PORT=${MONGO_GUI_PORT}
          MONGO_GUI_USER=${MONGO_GUI_USER}
          MONGO_GUI_PASSWORD=${MONGO_GUI_PASSWORD}

          # ========================================
          # CONFIGURAÃ‡Ã•ES DE SEGURANÃ‡A
          # ========================================
          APP_SECRET=${APP_SECRET}
          HCAPTCHA_SITEKEY=${HCAPTCHA_SITEKEY}
          HCAPTCHA_SECRET=${HCAPTCHA_SECRET}
          TOKEN_EXPIRES_IN=${TOKEN_EXPIRES_IN}

          # ========================================
          # CONFIGURAÃ‡Ã•ES DO SERVIÃ‡O DE EMAIL
          # ========================================
          MAILER_HOST=${MAILER_HOST}
          MAILER_PORT=${MAILER_PORT}
          MAILER_TLS=${MAILER_TLS}
          MAILER_SECURE=${MAILER_SECURE}
          MAILER_USER=${MAILER_USER}
          MAILER_PASS=${MAILER_PASS}
          MAILER_FROM=${MAILER_FROM}
          MAILER_DISABLED=${MAILER_DISABLED}

          # ========================================
          # MICRO SERVIÃ‡OS BACKEND
          # ========================================
          USER_SERVICE_HOST=${USER_SERVICE_HOST}
          USER_SERVICE_PORT=${USER_SERVICE_PORT}
          EVENT_SERVICE_HOST=${EVENT_SERVICE_HOST}
          EVENT_SERVICE_PORT=${EVENT_SERVICE_PORT}
          TOKEN_SERVICE_HOST=${TOKEN_SERVICE_HOST}
          TOKEN_SERVICE_PORT=${TOKEN_SERVICE_PORT}
          MAILER_SERVICE_HOST=${MAILER_SERVICE_HOST}
          MAILER_SERVICE_PORT=${MAILER_SERVICE_PORT}
          PERMISSION_SERVICE_HOST=${PERMISSION_SERVICE_HOST}
          PERMISSION_SERVICE_PORT=${PERMISSION_SERVICE_PORT}
          GENERIC_SERVICE_HOST=${GENERIC_SERVICE_HOST}
          GENERIC_SERVICE_PORT=${GENERIC_SERVICE_PORT}
          ACTIVITY_SERVICE_HOST=${ACTIVITY_SERVICE_HOST}
          ACTIVITY_SERVICE_PORT=${ACTIVITY_SERVICE_PORT}
          CERTIFICATE_SERVICE_HOST=${CERTIFICATE_SERVICE_HOST}
          CERTIFICATE_SERVICE_PORT=${CERTIFICATE_SERVICE_PORT}
          STORAGE_SERVICE_HOST=${STORAGE_SERVICE_HOST}
          STORAGE_SERVICE_PORT=${STORAGE_SERVICE_PORT}
          EOF

          echo "ğŸ“¤ Enviando .env para o servidor..."
          # remove possÃ­veis espaÃ§os de indentaÃ§Ã£o criados pelo heredoc e envia o arquivo limpo
          sed -e 's/^[[:space:]]*//' .env.deploy > .env.cleaned
          # envia .env.cleaned para a home do servidor (o script remoto cuidarÃ¡ do local final)
          scp -P ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            .env.cleaned \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/.env.cleaned

      # 5ï¸âƒ£ Atualiza o repositÃ³rio e sobe containers
      - name: ğŸš€ Atualizar repositÃ³rio e subir containers (assÃ­ncrono)
        run: |
          echo "ğŸš€ Iniciando deploy remoto (upload de script + .env)..."
          # envia o script de deploy e o .env.cleaned para a home do servidor
          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa deploy.sh ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/deploy.sh
          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa .env.cleaned ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/.env.cleaned

          # executa o script em background via nohup para nÃ£o depender da sessÃ£o SSH
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o ServerAliveCountMax=10 \
            -o TCPKeepAlive=yes \
            -o BatchMode=yes \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
            "chmod +x ~/deploy.sh && nohup ~/deploy.sh > ~/deploy_run.log 2>&1 & echo \$! > ~/deploy_pid && sleep 2 && tail -n 200 ~/deploy_run.log || true"

      # 6ï¸âƒ£ Healthcheck final
      - name: ğŸ©º Verificar status do serviÃ§o
        run: |
          echo "ğŸ©º Checando se o gateway estÃ¡ online..."
          curl -fsS http://200.128.9.4:4001/status || (
            echo "âŒ O serviÃ§o nÃ£o respondeu corretamente ao healthcheck." && exit 1
          )

          echo "âœ… Deploy validado com sucesso!"
