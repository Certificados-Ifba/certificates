name: Deploy Certificates IFBA (com Docker Registry)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production
      url: http://200.128.9.4:4000

    steps:
      # 1Ô∏è‚É£ Clona o reposit√≥rio
      - name: üì¶ Checkout c√≥digo
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Faz login no Docker Hub (ou GHCR)
      - name: üîê Login no Docker Registry
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 3Ô∏è‚É£ Gera nome da imagem
      - name: üè∑Ô∏è Definir tag da imagem
        id: vars
        run: |
          IMAGE_NAME="certificados-ifba"
          IMAGE_TAG=$(date +'%Y%m%d-%H%M%S')
          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

      # 4Ô∏è‚É£ Build e push da imagem
      - name: üèóÔ∏è Build e push da imagem para o registry
        run: |
          docker build -f Dockerfile -t ${{ secrets.DOCKER_USERNAME }}/${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.tag }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.tag }}

      # 5Ô∏è‚É£ Cria e envia o arquivo .env
      - name: üß© Gerar e enviar .env
        env:
          DOMAIN: ${{ vars.DOMAIN }}
          API_URI: ${{ vars.API_URI }}
          WEB_URL: ${{ vars.WEB_URL }}
          WEB_PORT: ${{ vars.WEB_PORT }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
          APP_SECRET: ${{ secrets.APP_SECRET }}
        run: |
          cat > .env.deploy <<EOF
          DOMAIN=${DOMAIN}
          API_URI=${API_URI}
          WEB_URL=${WEB_URL}
          WEB_PORT=${WEB_PORT}

          MONGO_HOST=${MONGO_HOST}
          MONGO_USER=${MONGO_USER}
          MONGO_PASSWORD=${MONGO_PASSWORD}
          MONGO_DATABASE=${MONGO_DATABASE}

          APP_SECRET=${APP_SECRET}
          DOCKER_IMAGE=${{ secrets.DOCKER_USERNAME }}/${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.tag }}
          EOF

          sed -e 's/^[[:space:]]*//' .env.deploy > .env.cleaned

          echo "üì§ Enviando .env atualizado para o servidor remoto..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa \
            .env.cleaned ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/certificates/.env

      # 6Ô∏è‚É£ Atualiza e sobe containers no servidor
      - name: üöÄ Atualizar containers no servidor remoto
        run: |
          ssh -T -p ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            -o ServerAliveCountMax=10 \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} <<'EOSSH'
          set -euo pipefail
          cd ~/certificates

          echo "üì• Atualizando c√≥digo..."
          if [ ! -d ".git" ]; then
            git clone https://github.com/Certificados-Ifba/certificates.git .
          else
            git fetch --all --prune
            git reset --hard origin/main
          fi

          echo "üì¶ Carregando imagem mais recente..."
          source .env
          docker pull $DOCKER_IMAGE

          echo "üßπ Parando containers antigos..."
          docker compose -f docker-compose.yml -f docker-compose.prod.yml down || true

          echo "‚¨ÜÔ∏è Subindo containers atualizados..."
          IMAGE=$DOCKER_IMAGE docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate

          echo "‚úÖ Deploy finalizado com sucesso em $(date)" > ~/deploy_log.txt
          EOSSH

      # 7Ô∏è‚É£ Healthcheck final
      - name: ü©∫ Healthcheck do servi√ßo
        run: |
          echo "ü©∫ Verificando se o gateway est√° online..."
          curl -fsS http://200.128.9.4:4000/status || (
            echo "‚ùå Healthcheck falhou ‚Äî verifique o servidor!" && exit 1
          )
          echo "‚úÖ Deploy validado com sucesso!"
