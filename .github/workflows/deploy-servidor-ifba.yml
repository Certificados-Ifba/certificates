name: Deploy Certificates IFBA (dev.up)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://200.128.9.4:4000

    steps:
      - name: üì¶ Checkout c√≥digo
        uses: actions/checkout@v3

      - name: üîë Configurar acesso SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: üåê Testar conex√£o SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
            "echo '‚úÖ Conex√£o SSH funcionando no servidor remoto!'"

      - name: üß© Gerar e enviar .env (mesmo conte√∫do que voc√™ j√° usa)
        env:
          DOMAIN: ${{ vars.DOMAIN }}
          API_URI: ${{ vars.API_URI }}
          WEB_URL: ${{ vars.WEB_URL }}
          WEB_PORT: ${{ vars.WEB_PORT }}
          API_GATEWAY_PORT: ${{ vars.API_GATEWAY_PORT }}
          API_GATEWAY_HOST: ${{ vars.API_GATEWAY_HOST }}
          HOST_MONGO_PORT: ${{ vars.HOST_MONGO_PORT }}
          MONGO_PORT: ${{ vars.MONGO_PORT }}
          MONGO_GUI_PORT: ${{ vars.MONGO_GUI_PORT }}
          HCAPTCHA_SITEKEY: ${{ vars.HCAPTCHA_SITEKEY }}
          MAILER_TLS: ${{ vars.MAILER_TLS }}
          MAILER_SECURE: ${{ vars.MAILER_SECURE }}
          MAILER_DISABLED: ${{ vars.MAILER_DISABLED }}

          USER_SERVICE_HOST: ${{ vars.USER_SERVICE_HOST }}
          USER_SERVICE_PORT: ${{ vars.USER_SERVICE_PORT }}
          EVENT_SERVICE_HOST: ${{ vars.EVENT_SERVICE_HOST }}
          EVENT_SERVICE_PORT: ${{ vars.EVENT_SERVICE_PORT }}
          TOKEN_SERVICE_HOST: ${{ vars.TOKEN_SERVICE_HOST }}
          TOKEN_SERVICE_PORT: ${{ vars.TOKEN_SERVICE_PORT }}
          MAILER_SERVICE_HOST: ${{ vars.MAILER_SERVICE_HOST }}
          MAILER_SERVICE_PORT: ${{ vars.MAILER_SERVICE_PORT }}
          PERMISSION_SERVICE_HOST: ${{ vars.PERMISSION_SERVICE_HOST }}
          PERMISSION_SERVICE_PORT: ${{ vars.PERMISSION_SERVICE_PORT }}
          GENERIC_SERVICE_HOST: ${{ vars.GENERIC_SERVICE_HOST }}
          GENERIC_SERVICE_PORT: ${{ vars.GENERIC_SERVICE_PORT }}
          ACTIVITY_SERVICE_HOST: ${{ vars.ACTIVITY_SERVICE_HOST }}
          ACTIVITY_SERVICE_PORT: ${{ vars.ACTIVITY_SERVICE_PORT }}
          CERTIFICATE_SERVICE_HOST: ${{ vars.CERTIFICATE_SERVICE_HOST }}
          CERTIFICATE_SERVICE_PORT: ${{ vars.CERTIFICATE_SERVICE_PORT }}
          STORAGE_SERVICE_HOST: ${{ vars.STORAGE_SERVICE_HOST }}
          STORAGE_SERVICE_PORT: ${{ vars.STORAGE_SERVICE_PORT }}

          APP_SECRET: ${{ secrets.APP_SECRET }}
          HCAPTCHA_SECRET: ${{ secrets.HCAPTCHA_SECRET }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
          MONGODB_ROOT_PASSWORD: ${{ secrets.MONGODB_ROOT_PASSWORD }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_GUI_USER: ${{ secrets.MONGO_GUI_USER }}
          MONGO_GUI_PASSWORD: ${{ secrets.MONGO_GUI_PASSWORD }}
          TOKEN_EXPIRES_IN: ${{ secrets.TOKEN_EXPIRES_IN }}
          MAILER_HOST: ${{ secrets.MAILER_HOST }}
          MAILER_PORT: ${{ secrets.MAILER_PORT }}
          MAILER_USER: ${{ secrets.MAILER_USER }}
          MAILER_PASS: ${{ secrets.MAILER_PASS }}
          MAILER_FROM: ${{ secrets.MAILER_FROM }}
        run: |
          cat > .env.deploy <<EOF
          DOMAIN=${DOMAIN}
          API_URI=${API_URI}
          WEB_URL=${WEB_URL}
          WEB_PORT=${WEB_PORT}
          API_GATEWAY_PORT=${API_GATEWAY_PORT}
          API_GATEWAY_HOST=${API_GATEWAY_HOST}

          MONGO_USER=${MONGO_USER}
          MONGO_PASSWORD=${MONGO_PASSWORD}
          MONGO_DATABASE=${MONGO_DATABASE}
          MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
          MONGO_PORT=${MONGO_PORT}
          HOST_MONGO_PORT=${HOST_MONGO_PORT}
          MONGO_HOST=${MONGO_HOST}
          MONGO_GUI_PORT=${MONGO_GUI_PORT}
          MONGO_GUI_USER=${MONGO_GUI_USER}
          MONGO_GUI_PASSWORD=${MONGO_GUI_PASSWORD}

          APP_SECRET=${APP_SECRET}
          HCAPTCHA_SITEKEY=${HCAPTCHA_SITEKEY}
          HCAPTCHA_SECRET=${HCAPTCHA_SECRET}
          TOKEN_EXPIRES_IN=${TOKEN_EXPIRES_IN}

          MAILER_HOST=${MAILER_HOST}
          MAILER_PORT=${MAILER_PORT}
          MAILER_TLS=${MAILER_TLS}
          MAILER_SECURE=${MAILER_SECURE}
          MAILER_USER=${MAILER_USER}
          MAILER_PASS=${MAILER_PASS}
          MAILER_FROM=${MAILER_FROM}
          MAILER_DISABLED=${MAILER_DISABLED}

          USER_SERVICE_HOST=${USER_SERVICE_HOST}
          USER_SERVICE_PORT=${USER_SERVICE_PORT}
          EVENT_SERVICE_HOST=${EVENT_SERVICE_HOST}
          EVENT_SERVICE_PORT=${EVENT_SERVICE_PORT}
          TOKEN_SERVICE_HOST=${TOKEN_SERVICE_HOST}
          TOKEN_SERVICE_PORT=${TOKEN_SERVICE_PORT}
          MAILER_SERVICE_HOST=${MAILER_SERVICE_HOST}
          MAILER_SERVICE_PORT=${MAILER_SERVICE_PORT}
          PERMISSION_SERVICE_HOST=${PERMISSION_SERVICE_HOST}
          PERMISSION_SERVICE_PORT=${PERMISSION_SERVICE_PORT}
          GENERIC_SERVICE_HOST=${GENERIC_SERVICE_HOST}
          GENERIC_SERVICE_PORT=${GENERIC_SERVICE_PORT}
          ACTIVITY_SERVICE_HOST=${ACTIVITY_SERVICE_HOST}
          ACTIVITY_SERVICE_PORT=${ACTIVITY_SERVICE_PORT}
          CERTIFICATE_SERVICE_HOST=${CERTIFICATE_SERVICE_HOST}
          CERTIFICATE_SERVICE_PORT=${CERTIFICATE_SERVICE_PORT}
          STORAGE_SERVICE_HOST=${STORAGE_SERVICE_HOST}
          STORAGE_SERVICE_PORT=${STORAGE_SERVICE_PORT}
          EOF

          sed -e 's/^[[:space:]]*//' .env.deploy > .env.cleaned
          ssh -p ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} "mkdir -p ~/certificates"
          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa .env.cleaned \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/certificates/.env

      - name: üöÄ Atualizar repo e executar docker-compose (dev.up)
        run: |
          ssh -T -p ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=4 \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} <<'EOSSH'
          set -euo pipefail
          cd ~

          # clone/atualiza
          if [ ! -d "certificates/.git" ]; then
            git clone https://github.com/Certificados-Ifba/certificates.git certificates
          else
            cd certificates
            git fetch --all --prune
            git reset --hard origin/main
            git checkout main || true
            git pull origin main || true
            cd ..
          fi

          cd certificates

          # (opcional) parar os servi√ßos desse compose antes
          docker-compose -f docker-compose.yml -f docker-compose.dev.yml down || true

          # ‚öôÔ∏è EXATAMENTE O QUE O dev.up FAZ:
          docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d --remove-orphans

          echo "‚úÖ dev.up conclu√≠do em $(date)" > ~/deploy_log.txt
          EOSSH

      - name: ü©∫ Healthcheck gateway (porta dev)
        run: |
          curl -fsS http://200.128.9.4:4001/status || (
            echo "‚ùå Healthcheck falhou" && exit 1
          )
          echo "‚úÖ OK"
