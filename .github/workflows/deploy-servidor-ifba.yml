name: Deploy Certificates IFBA (prod.up)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production
      url: http://200.128.9.4:4000

    steps:
      - name: ğŸ“¦ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”‘ Configurar acesso SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: ğŸŒ Testar conexÃ£o SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
            "echo 'âœ… ConexÃ£o SSH funcionando no servidor remoto!'"

      - name: ğŸ§© Gerar e enviar .env
        env:
          # Vars nÃ£o secretas (Settings > Environments > production > Variables)
          DOMAIN: ${{ vars.DOMAIN }}
          API_URI: ${{ vars.API_URI }}
          WEB_URL: ${{ vars.WEB_URL }}
          WEB_PORT: ${{ vars.WEB_PORT }}
          API_GATEWAY_PORT: ${{ vars.API_GATEWAY_PORT }}
          API_GATEWAY_HOST: ${{ vars.API_GATEWAY_HOST }}
          HOST_MONGO_PORT: ${{ vars.HOST_MONGO_PORT }}
          MONGO_PORT: ${{ vars.MONGO_PORT }}
          MONGO_GUI_PORT: ${{ vars.MONGO_GUI_PORT }}
          HCAPTCHA_SITEKEY: ${{ vars.HCAPTCHA_SITEKEY }}
          MAILER_TLS: ${{ vars.MAILER_TLS }}
          MAILER_SECURE: ${{ vars.MAILER_SECURE }}
          MAILER_DISABLED: ${{ vars.MAILER_DISABLED }}
          USER_SERVICE_HOST: ${{ vars.USER_SERVICE_HOST }}
          USER_SERVICE_PORT: ${{ vars.USER_SERVICE_PORT }}
          EVENT_SERVICE_HOST: ${{ vars.EVENT_SERVICE_HOST }}
          EVENT_SERVICE_PORT: ${{ vars.EVENT_SERVICE_PORT }}
          TOKEN_SERVICE_HOST: ${{ vars.TOKEN_SERVICE_HOST }}
          TOKEN_SERVICE_PORT: ${{ vars.TOKEN_SERVICE_PORT }}
          MAILER_SERVICE_HOST: ${{ vars.MAILER_SERVICE_HOST }}
          MAILER_SERVICE_PORT: ${{ vars.MAILER_SERVICE_PORT }}
          PERMISSION_SERVICE_HOST: ${{ vars.PERMISSION_SERVICE_HOST }}
          PERMISSION_SERVICE_PORT: ${{ vars.PERMISSION_SERVICE_PORT }}
          GENERIC_SERVICE_HOST: ${{ vars.GENERIC_SERVICE_HOST }}
          GENERIC_SERVICE_PORT: ${{ vars.GENERIC_SERVICE_PORT }}
          ACTIVITY_SERVICE_HOST: ${{ vars.ACTIVITY_SERVICE_HOST }}
          ACTIVITY_SERVICE_PORT: ${{ vars.ACTIVITY_SERVICE_PORT }}
          CERTIFICATE_SERVICE_HOST: ${{ vars.CERTIFICATE_SERVICE_HOST }}
          CERTIFICATE_SERVICE_PORT: ${{ vars.CERTIFICATE_SERVICE_PORT }}
          STORAGE_SERVICE_HOST: ${{ vars.STORAGE_SERVICE_HOST }}
          STORAGE_SERVICE_PORT: ${{ vars.STORAGE_SERVICE_PORT }}
          # Secrets
          APP_SECRET: ${{ secrets.APP_SECRET }}
          HCAPTCHA_SECRET: ${{ secrets.HCAPTCHA_SECRET }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
          MONGODB_ROOT_PASSWORD: ${{ secrets.MONGODB_ROOT_PASSWORD }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_GUI_USER: ${{ secrets.MONGO_GUI_USER }}
          MONGO_GUI_PASSWORD: ${{ secrets.MONGO_GUI_PASSWORD }}
          TOKEN_EXPIRES_IN: ${{ secrets.TOKEN_EXPIRES_IN }}
          MAILER_HOST: ${{ secrets.MAILER_HOST }}
          MAILER_PORT: ${{ secrets.MAILER_PORT }}
          MAILER_USER: ${{ secrets.MAILER_USER }}
          MAILER_PASS: ${{ secrets.MAILER_PASS }}
          MAILER_FROM: ${{ secrets.MAILER_FROM }}
        run: |
          cat > .env.deploy <<'EOF'
          DOMAIN=${DOMAIN}
          API_URI=${API_URI}
          WEB_URL=${WEB_URL}
          WEB_PORT=${WEB_PORT}
          API_GATEWAY_PORT=${API_GATEWAY_PORT}
          API_GATEWAY_HOST=${API_GATEWAY_HOST}

          MONGO_USER=${MONGO_USER}
          MONGO_PASSWORD=${MONGO_PASSWORD}
          MONGO_DATABASE=${MONGO_DATABASE}
          MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
          MONGO_PORT=${MONGO_PORT}
          HOST_MONGO_PORT=${HOST_MONGO_PORT}
          MONGO_HOST=${MONGO_HOST}
          MONGO_GUI_PORT=${MONGO_GUI_PORT}
          MONGO_GUI_USER=${MONGO_GUI_USER}
          MONGO_GUI_PASSWORD=${MONGO_GUI_PASSWORD}

          APP_SECRET=${APP_SECRET}
          HCAPTCHA_SITEKEY=${HCAPTCHA_SITEKEY}
          HCAPTCHA_SECRET=${HCAPTCHA_SECRET}
          TOKEN_EXPIRES_IN=${TOKEN_EXPIRES_IN}

          MAILER_HOST=${MAILER_HOST}
          MAILER_PORT=${MAILER_PORT}
          MAILER_TLS=${MAILER_TLS}
          MAILER_SECURE=${MAILER_SECURE}
          MAILER_USER=${MAILER_USER}
          MAILER_PASS=${MAILER_PASS}
          MAILER_FROM=${MAILER_FROM}
          MAILER_DISABLED=${MAILER_DISABLED}

          USER_SERVICE_HOST=${USER_SERVICE_HOST}
          USER_SERVICE_PORT=${USER_SERVICE_PORT}
          EVENT_SERVICE_HOST=${EVENT_SERVICE_HOST}
          EVENT_SERVICE_PORT=${EVENT_SERVICE_PORT}
          TOKEN_SERVICE_HOST=${TOKEN_SERVICE_HOST}
          TOKEN_SERVICE_PORT=${TOKEN_SERVICE_PORT}
          MAILER_SERVICE_HOST=${MAILER_SERVICE_HOST}
          MAILER_SERVICE_PORT=${MAILER_SERVICE_PORT}
          PERMISSION_SERVICE_HOST=${PERMISSION_SERVICE_HOST}
          PERMISSION_SERVICE_PORT=${PERMISSION_SERVICE_PORT}
          GENERIC_SERVICE_HOST=${GENERIC_SERVICE_HOST}
          GENERIC_SERVICE_PORT=${GENERIC_SERVICE_PORT}
          ACTIVITY_SERVICE_HOST=${ACTIVITY_SERVICE_HOST}
          ACTIVITY_SERVICE_PORT=${ACTIVITY_SERVICE_PORT}
          CERTIFICATE_SERVICE_HOST=${CERTIFICATE_SERVICE_HOST}
          CERTIFICATE_SERVICE_PORT=${CERTIFICATE_SERVICE_PORT}
          STORAGE_SERVICE_HOST=${STORAGE_SERVICE_HOST}
          STORAGE_SERVICE_PORT=${STORAGE_SERVICE_PORT}
          EOF

          # limpa indentaÃ§Ã£o acidental e envia
          sed -e 's/^[[:space:]]*//' .env.deploy > .env.cleaned

          ssh -p ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} "mkdir -p ~/certificates"

          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa .env.cleaned \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/certificates/.env

      - name: ğŸ“œ Enviar script deploy.sh e disparar execuÃ§Ã£o em background
        run: |
          # gera o deploy.sh localmente e envia
          cat > deploy.sh <<'EOSCRIPT'
          #!/usr/bin/env bash
          set -euo pipefail

          BASE=~/certificates
          LOG=~/deploy_run.log

          echo "=== $(date) | Iniciando deploy (prod.up) ===" | tee -a "$LOG"

          if [ ! -d "$BASE" ]; then
            mkdir -p "$BASE"
          fi

          cd "$BASE"

          if [ ! -d ".git" ]; then
            echo "[git] clone..." | tee -a "$LOG"
            git clone https://github.com/Certificados-Ifba/certificates.git .
          else
            echo "[git] fetch/reset main..." | tee -a "$LOG"
            git fetch --all --prune
            git reset --hard origin/main
          fi

          # avisa sobre o campo 'version' no compose (apenas warning informativo)
          echo "[docker] build (compose prod)..." | tee -a "$LOG"
          # forÃ§a saÃ­da contÃ­nua pra nÃ£o â€œcalarâ€ a sessÃ£o
          stdbuf -oL docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache --force-rm 2>&1 | tee -a "$LOG"

          echo "[docker] prune imagens antigas..." | tee -a "$LOG"
          docker system prune -a -f | tee -a "$LOG" || true

          echo "[docker] up -d (compose prod)..." | tee -a "$LOG"
          stdbuf -oL docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --remove-orphans 2>&1 | tee -a "$LOG"

          echo "=== $(date) | Deploy finalizado ===" | tee -a "$LOG"
          EOSCRIPT

          sed -e 's/^[[:space:]]*//' -i deploy.sh
          chmod +x deploy.sh

          scp -P ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa deploy.sh \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/deploy.sh

          # executa em background com nohup e inicia tail do log (nÃ£o bloqueia o job)
          ssh -p ${{ secrets.SERVER_SSH_PORT }} -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
            "nohup bash ~/deploy.sh >/dev/null 2>&1 & echo \$! > ~/deploy_pid; sleep 3; tail -n 200 ~/deploy_run.log || true"

      - name: ğŸ©º Healthcheck gateway (produÃ§Ã£o)
        run: |
          # dÃ¡ um respiro pro serviÃ§o subir (ajuste se precisar)
          sleep 10
          echo "ğŸ©º Checando http://200.128.9.4:4000/status ..."
          curl -fsS http://200.128.9.4:4000/status || (echo "âŒ Healthcheck falhou" && exit 1)
          echo "âœ… OK"
