name: Deploy Certificates IFBA

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://200.128.9.4:4000

    steps:
      # 1Ô∏è‚É£ Clona o reposit√≥rio (necess√°rio pro Actions pegar estrutura)
      - name: üì¶ Checkout c√≥digo
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Configura o SSH (chave privada vinda do secret)
      - name: üîë Configurar acesso SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # 3Ô∏è‚É£ Testa se a conex√£o SSH com o servidor remoto funciona
      - name: üåê Testar conex√£o SSH
        run: |
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
              -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} \
              "echo '‚úÖ Conex√£o SSH funcionando no servidor remoto!'"

      # 4Ô∏è‚É£ Gera e envia o arquivo .env completo
      - name: üß© Gerar e enviar arquivo .env
        env:
          # üîß Vari√°veis de ambiente (n√£o secretas)
          DOMAIN: ${{ vars.DOMAIN }}
          API_URI: ${{ vars.API_URI }}
          WEB_URL: ${{ vars.WEB_URL }}
          WEB_PORT: ${{ vars.WEB_PORT }}
          API_GATEWAY_PORT: ${{ vars.API_GATEWAY_PORT }}
          API_GATEWAY_HOST: ${{ vars.API_GATEWAY_HOST }}
          HOST_MONGO_PORT: ${{ vars.HOST_MONGO_PORT }}
          MONGO_PORT: ${{ vars.MONGO_PORT }}
          MONGO_GUI_PORT: ${{ vars.MONGO_GUI_PORT }}
          HCAPTCHA_SITEKEY: ${{ vars.HCAPTCHA_SITEKEY }}
          MAILER_TLS: ${{ vars.MAILER_TLS }}
          MAILER_SECURE: ${{ vars.MAILER_SECURE }}
          MAILER_DISABLED: ${{ vars.MAILER_DISABLED }}

          # üß© Microservi√ßos backend
          USER_SERVICE_HOST: ${{ vars.USER_SERVICE_HOST }}
          USER_SERVICE_PORT: ${{ vars.USER_SERVICE_PORT }}
          EVENT_SERVICE_HOST: ${{ vars.EVENT_SERVICE_HOST }}
          EVENT_SERVICE_PORT: ${{ vars.EVENT_SERVICE_PORT }}
          TOKEN_SERVICE_HOST: ${{ vars.TOKEN_SERVICE_HOST }}
          TOKEN_SERVICE_PORT: ${{ vars.TOKEN_SERVICE_PORT }}
          MAILER_SERVICE_HOST: ${{ vars.MAILER_SERVICE_HOST }}
          MAILER_SERVICE_PORT: ${{ vars.MAILER_SERVICE_PORT }}
          PERMISSION_SERVICE_HOST: ${{ vars.PERMISSION_SERVICE_HOST }}
          PERMISSION_SERVICE_PORT: ${{ vars.PERMISSION_SERVICE_PORT }}
          GENERIC_SERVICE_HOST: ${{ vars.GENERIC_SERVICE_HOST }}
          GENERIC_SERVICE_PORT: ${{ vars.GENERIC_SERVICE_PORT }}
          ACTIVITY_SERVICE_HOST: ${{ vars.ACTIVITY_SERVICE_HOST }}
          ACTIVITY_SERVICE_PORT: ${{ vars.ACTIVITY_SERVICE_PORT }}
          CERTIFICATE_SERVICE_HOST: ${{ vars.CERTIFICATE_SERVICE_HOST }}
          CERTIFICATE_SERVICE_PORT: ${{ vars.CERTIFICATE_SERVICE_PORT }}
          STORAGE_SERVICE_HOST: ${{ vars.STORAGE_SERVICE_HOST }}
          STORAGE_SERVICE_PORT: ${{ vars.STORAGE_SERVICE_PORT }}

          # üîê Secrets sens√≠veis
          APP_SECRET: ${{ secrets.APP_SECRET }}
          HCAPTCHA_SECRET: ${{ secrets.HCAPTCHA_SECRET }}
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DATABASE: ${{ secrets.MONGO_DATABASE }}
          MONGODB_ROOT_PASSWORD: ${{ secrets.MONGODB_ROOT_PASSWORD }}
          MONGO_HOST: ${{ secrets.MONGO_HOST }}
          MONGO_GUI_USER: ${{ secrets.MONGO_GUI_USER }}
          MONGO_GUI_PASSWORD: ${{ secrets.MONGO_GUI_PASSWORD }}
          TOKEN_EXPIRES_IN: ${{ secrets.TOKEN_EXPIRES_IN }}
          MAILER_HOST: ${{ secrets.MAILER_HOST }}
          MAILER_PORT: ${{ secrets.MAILER_PORT }}
          MAILER_USER: ${{ secrets.MAILER_USER }}
          MAILER_PASS: ${{ secrets.MAILER_PASS }}
          MAILER_FROM: ${{ secrets.MAILER_FROM }}

        run: |
          echo "üìÑ Gerando .env.deploy..."

          cat > .env.deploy <<EOF
          # ========================================
          # CONFIGURA√á√ïES DE DOM√çNIO E HOSTS
          # ========================================
          DOMAIN=${DOMAIN}
          API_URI=${API_URI}
          WEB_URL=${WEB_URL}
          WEB_PORT=${WEB_PORT}
          API_GATEWAY_PORT=${API_GATEWAY_PORT}
          API_GATEWAY_HOST=${API_GATEWAY_HOST}

          # ========================================
          # CONFIGURA√á√ïES DO MONGODB
          # ========================================
          MONGO_USER=${MONGO_USER}
          MONGO_PASSWORD=${MONGO_PASSWORD}
          MONGO_DATABASE=${MONGO_DATABASE}
          MONGODB_ROOT_PASSWORD=${MONGODB_ROOT_PASSWORD}
          MONGO_PORT=${MONGO_PORT}
          HOST_MONGO_PORT=${HOST_MONGO_PORT}
          MONGO_HOST=${MONGO_HOST}
          MONGO_GUI_PORT=${MONGO_GUI_PORT}
          MONGO_GUI_USER=${MONGO_GUI_USER}
          MONGO_GUI_PASSWORD=${MONGO_GUI_PASSWORD}

          # ========================================
          # CONFIGURA√á√ïES DE SEGURAN√áA
          # ========================================
          APP_SECRET=${APP_SECRET}
          HCAPTCHA_SITEKEY=${HCAPTCHA_SITEKEY}
          HCAPTCHA_SECRET=${HCAPTCHA_SECRET}
          TOKEN_EXPIRES_IN=${TOKEN_EXPIRES_IN}

          # ========================================
          # CONFIGURA√á√ïES DO SERVI√áO DE EMAIL
          # ========================================
          MAILER_HOST=${MAILER_HOST}
          MAILER_PORT=${MAILER_PORT}
          MAILER_TLS=${MAILER_TLS}
          MAILER_SECURE=${MAILER_SECURE}
          MAILER_USER=${MAILER_USER}
          MAILER_PASS=${MAILER_PASS}
          MAILER_FROM=${MAILER_FROM}
          MAILER_DISABLED=${MAILER_DISABLED}

          # ========================================
          # MICRO SERVI√áOS BACKEND
          # ========================================
          USER_SERVICE_HOST=${USER_SERVICE_HOST}
          USER_SERVICE_PORT=${USER_SERVICE_PORT}
          EVENT_SERVICE_HOST=${EVENT_SERVICE_HOST}
          EVENT_SERVICE_PORT=${EVENT_SERVICE_PORT}
          TOKEN_SERVICE_HOST=${TOKEN_SERVICE_HOST}
          TOKEN_SERVICE_PORT=${TOKEN_SERVICE_PORT}
          MAILER_SERVICE_HOST=${MAILER_SERVICE_HOST}
          MAILER_SERVICE_PORT=${MAILER_SERVICE_PORT}
          PERMISSION_SERVICE_HOST=${PERMISSION_SERVICE_HOST}
          PERMISSION_SERVICE_PORT=${PERMISSION_SERVICE_PORT}
          GENERIC_SERVICE_HOST=${GENERIC_SERVICE_HOST}
          GENERIC_SERVICE_PORT=${GENERIC_SERVICE_PORT}
          ACTIVITY_SERVICE_HOST=${ACTIVITY_SERVICE_HOST}
          ACTIVITY_SERVICE_PORT=${ACTIVITY_SERVICE_PORT}
          CERTIFICATE_SERVICE_HOST=${CERTIFICATE_SERVICE_HOST}
          CERTIFICATE_SERVICE_PORT=${CERTIFICATE_SERVICE_PORT}
          STORAGE_SERVICE_HOST=${STORAGE_SERVICE_HOST}
          STORAGE_SERVICE_PORT=${STORAGE_SERVICE_PORT}
          EOF

          echo "üì§ Enviando .env para o servidor..."
          # remove poss√≠veis espa√ßos de indenta√ß√£o criados pelo heredoc e envia o arquivo limpo
          sed -e 's/^[[:space:]]*//' .env.deploy > .env.cleaned
          scp -P ${{ secrets.SERVER_SSH_PORT }} \
            -i ~/.ssh/id_rsa \
            .env.cleaned \
            ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }}:~/certificates/.env

      # 5Ô∏è‚É£ Atualiza o reposit√≥rio e sobe containers
      - name: üöÄ Atualizar reposit√≥rio e subir containers
        run: |
          echo "üöÄ Iniciando deploy remoto..."
          ssh -p ${{ secrets.SERVER_SSH_PORT }} \
              -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_SSH_USER }}@${{ secrets.SERVER_SSH_HOST }} <<'ENDSSH'
                set -euo pipefail
                cd ~

                # üìÅ Clona ou atualiza o reposit√≥rio (mais robusto)
                if [ ! -d "certificates" ]; then
                  echo "üì• Clonando reposit√≥rio pela primeira vez..."
                  git clone https://github.com/Certificados-Ifba/certificates.git certificates
                else
                  # existe o diret√≥rio certificates
                  if [ -d "certificates/.git" ]; then
                    echo "üîÑ Diret√≥rio j√° √© um reposit√≥rio git ‚Äî atualizando (main)..."
                    cd certificates
                    git fetch --all --prune
                    git reset --hard origin/main
                    git checkout main || true
                    git pull origin main || true
                    cd ..
                  else
                    # diret√≥rio existe mas n√£o √© um repo git ‚Äî faz backup e clona novamente
                    ts=$(date +%s)
                    echo "‚ö†Ô∏è Diret√≥rio ~/certificates existe e n√£o √© um repo git ‚Äî movendo para ~/certificates.bak.$ts"
                    mv certificates "certificates.bak.$ts"
                    git clone https://github.com/Certificados-Ifba/certificates.git certificates
                  fi
                fi

                cd certificates

                echo "üîª Parando containers antigos..."
                docker compose down || true

                echo "‚¨ÜÔ∏è Subindo containers com nova vers√£o..."
                docker compose --env-file .env up -d --build

                echo "üßπ Limpando imagens antigas..."
                docker image prune -af --filter "until=24h" || true

                echo "‚úÖ Deploy conclu√≠do com sucesso em $(date)" > ~/deploy_log.txt
              ENDSSH

      # 6Ô∏è‚É£ Healthcheck final
      - name: ü©∫ Verificar status do servi√ßo
        run: |
          echo "ü©∫ Checando se o gateway est√° online..."
          curl -fsS http://200.128.9.4:4001/status || (
            echo "‚ùå O servi√ßo n√£o respondeu corretamente ao healthcheck." && exit 1
          )

          echo "‚úÖ Deploy validado com sucesso!"
